# 小波变换去噪详细说明

## 小波分解阶段

### 函数调用
```python
coeffs = pywt.wavedec(data=data, wavelet='db5', level=9)
```

### 参数详解

#### data
- **含义**: 输入的ECG信号数据
- **类型**: 一维数组
- **示例**: 长度为300的ECG片段

#### wavelet='db5'
- **全称**: Daubechies 5小波
- **特点**:
  - **紧支撑性**: 有限长度，适合信号处理
  - **正交性**: 不同尺度的小波函数正交
  - **近似对称性**: 减少相位失真
  - **5阶消失矩**: 能有效表示多项式信号

- **选择db5的原因**:
  - 适合ECG信号的频率特性
  - 能很好地捕捉心电信号的突变点（如QRS波群）
  - 滤波器长度适中（10个系数）

#### level=9
- **含义**: 9层小波分解
- **频率分割**（假设采样率360Hz）:
  - cD1: 90-180 Hz
  - cD2: 45-90 Hz
  - cD3: 22.5-45 Hz
  - cD4: 11.25-22.5 Hz
  - cD5: 5.6-11.25 Hz
  - cD6: 2.8-5.6 Hz
  - cD7: 1.4-2.8 Hz
  - cD8: 0.7-1.4 Hz
  - cA9: 0-0.7 Hz

### 分解结果

| 系数 | 类型 | 频率范围 | 主要成分 |
|------|------|----------|----------|
| cA9 | 近似系数 | 0-0.7 Hz | 基线漂移、极低频 |
| cD9 | 细节系数 | 0.7-1.4 Hz | 低频心电成分 |
| cD8 | 细节系数 | 1.4-2.8 Hz | P波、T波 |
| cD7 | 细节系数 | 2.8-5.6 Hz | P波、T波、基线 |
| cD6 | 细节系数 | 5.6-11.25 Hz | P波、T波 |
| cD5 | 细节系数 | 11.25-22.5 Hz | QRS波群、P波T波 |
| cD4 | 细节系数 | 22.5-45 Hz | QRS波群高频部分 |
| cD3 | 细节系数 | 45-90 Hz | 高频心电成分、肌电 |
| cD2 | 细节系数 | 90-180 Hz | 高频噪声、部分肌电 |
| cD1 | 细节系数 | 180-360 Hz | 高频噪声、肌电干扰 |

## 阈值计算

### 公式
```python
threshold = (np.median(np.abs(cD1)) / 0.6745) * (np.sqrt(2 * np.log(len(cD1))))
```

### Donoho-Johnstone通用阈值

#### 第一部分：噪声标准差估计
```python
np.median(np.abs(cD1)) / 0.6745
```
- **cD1**: 第一层细节系数（最高频成分）
- **median**: 绝对值的中位数，对异常值鲁棒
- **0.6745**: 高斯分布的标准差估计因子
  - 对于标准正态分布N(0,1)，中位数约为0.6745
  - 用于从噪声信号中估计真实噪声标准差

#### 第二部分：长度因子
```python
np.sqrt(2 * np.log(len(cD1)))
```
- **len(cD1)**: 第一层细节系数的长度
- **理论基础**: 极值理论的渐进性质
- **作用**: 平衡信号长度对阈值的影响

### 阈值选择原理
- **渐进最优性**: 在正交小波变换下具有理论最优性
- **自适应**: 根据信号特性自动调整
- **鲁棒性**: 对加性高斯白噪声有效

## 系数处理策略

### 1. 直接置零高频噪声
```python
cD1.fill(0)  # 90-180 Hz
cD2.fill(0)  # 45-90 Hz
```
- **原因**: ECG信号的有用成分主要在中低频段
- **效果**: 最大限度去除高频噪声
- **成分**:
  - 肌电噪声（EMG）
  - 50/60Hz工频干扰
  - 采样量化噪声

### 2. 软阈值处理中频系数
```python
for i in range(1, len(coeffs) - 2):
    coeffs[i] = pywt.threshold(coeffs[i], threshold)
```

#### 软阈值函数
```
soft_threshold(x) = sign(x) * max(|x| - threshold, 0)
```
- **特点**: 连续函数，避免重构时的振荡
- **效果**:
  - 小于阈值的系数 → 置零
  - 大于阈值的系数 → 向零收缩
- **适用范围**: cD3到cD7（2.8-45 Hz）

#### 软阈值 vs 硬阈值

| 特性 | 软阈值 | 硬阈值 |
|------|--------|--------|
| 连续性 | 连续 | 不连续 |
| 偏差 | 有偏差 | 无偏差 |
| 方差 | 较大 | 较小 |
| 适用性 | 信号平滑 | 保留峰值 |
| 推荐场景 | ECG等生物信号 | 稀疏信号 |

### 3. 保留低频成分
- **cA9, cD8, cD9**: 基本不做处理
- **原因**: 包含重要的心电形态信息
- **成分**: P波、QRS波群、T波的基本形态

## 信号重构

### 函数调用
```python
rdata = pywt.waverec(coeffs=coeffs, wavelet='db5')
```

### 重构原理
1. **从高层到低层**: 逐层进行逆小波变换
2. **系数合并**: 每层将近似和细节系数合并
3. **完美重构**: 理论上可完美重构原始信号

### 重构条件
- **小波基一致性**: 必须使用与分解相同的小波基
- **系数完整性**: 所有层的系数都需要
- **长度处理**: 自动处理系数长度对齐

## 算法优势

### 1. 自适应性
- 根据信号频率特性自动调整
- 无需预设滤波器参数

### 2. 时频局部化
- 同时提供时域和频域信息
- 保持信号的时间局部特征

### 3. 多分辨率分析
- 不同尺度分析信号特征
- 有效分离信号和噪声

### 4. 保留形态特征
- 保留QRS波群的尖锐特征
- 维持P波、T波的形态

## 实际应用建议

### 参数调整
- **小波基选择**:
  - db4-db8适合ECG信号
  - bior系列也常用于生物信号
- **分解层数**:
  - 采样率/100Hz作为参考
  - 360Hz建议6-9层

### 质量评估
- **视觉评估**: 信号平滑度和特征保持
- **定量指标**:
  - 信噪比改善（SNR）
  - 均方误差（MSE）
  - 相关系数

### 注意事项
1. **基线漂移**: 可能需要额外处理
2. **工频干扰**: 可先陷波滤波
3. **信号长度**: 需要足够长度以准确估计噪声